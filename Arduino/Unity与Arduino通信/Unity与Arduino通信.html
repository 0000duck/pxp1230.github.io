<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <title>Unity与Arduino通信 - </title>
  <style type="text/css">code{white-space: pre;}</style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  <style type="text/css">body{font:14px/200%"Hiragino Sans GB","Microsoft YaHei",tahoma,arial,simsun;color:#00CCFF;background:#1A1A1A;word-wrap:break-word;word-break:normal}img{max-width:100%}html,body,h1,h2,h3,h4,h5,h6,p,blockquote,ol,ul,li,img,li div{margin:0;padding:0;font:14px/200%"Hiragino Sans GB","Microsoft YaHei",tahoma,arial,simsun;line-height:22px;vertical-align:baseline;color:#00CCFF}body{margin:10px}p,div{margin-bottom:20px}strong{font-weight:bold}ol,ul{margin-left:2em;margin-bottom:20px}ul ul,ol ol,ul ol,ol ul{margin-top:10px}li{margin-bottom:10px}h1,h2,h3,h4,h5,h6{font-weight:lighter;text-transform:capitalize;margin-top:20px;margin-bottom:20px}h1{font-size:24.624px;line-height:29.548799999999996px}h2{font-size:24.624px;line-height:29.548799999999996px}h3{font-size:23.44px;line-height:28.128px}h4{font-size:22.16px;line-height:26.592px}h5{font-size:22.16px;line-height:26.592px}h6{font-size:22.16px;line-height:26.592px}img{margin-bottom:20px}h1 img,h2 img,h3 img,h4 img,h5 img,h6 img,p img{margin-bottom:0}pre{color:#00CCFF;margin-bottom:20px;white-space:pre;white-space:pre-wrap;word-wrap:break-word}code{font-family:Menlo,Monaco,Consolas,"Andale Mono","lucida console","Courier New",monospace;font-size:12px;line-height:1.5;box-shadow:0 0 8px rgba(0,0,0,0.4);padding:2px 4px;color:#FC0;background-color:#232400;border:1px solid#333500;border-radius:3px}pre>code{padding:1em!important;border:none!important}h1{text-transform:uppercase;font-weight:bold;border-bottom:1px solid;padding-bottom:4px}h2{border-bottom:1px solid;padding-bottom:4px}h3,h4,h5,h6{border-bottom:none}html body{background-color:#1A1A1A}html h1,html h2,html h3,html h4,html h5,html h6{color:#FFCC00;border-color:#FFCC00}html a,html a:active,html a:visited{color:#FFCC00}html a:hover{background-color:#554400}html a,html a:active,html a:visited,html code.url{color:#FFCC00}html h2,html h3,html h4,html h5,html h6{color:#FFCC00}hr{border:0;background-color:#CC0000;height:4px;margin:40px auto}blockquote{background:#073642;border-left:10px solid#005266;margin:1.5em 10px;padding:.5em 10px}blockquote code{color:#00CCFF;font-family:"Hiragino Sans GB","Microsoft YaHei",tahoma,arial,simsun}blockquote pre{margin:0;padding:0}blockquote p,blockquote div{margin-bottom:0}strong{color:#FFCC00}</style>
  
  
  <meta charset="UTF-8"/>
  <meta name="author" content="潘霄鹏 - weibo.com/pxp1230">
  <meta name="keywords" content="潘霄鹏笔记">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
  tex2jax: {inlineMath:[['$','$']],processEscapes:true}
  });
  </script>
  <script type="text/javascript"
  src="file:///storage/emulated/0/MathJax-master/MathJax-master/MathJax.js?config=TeX-AMS_HTML">
  </script>
  <script type="text/javascript"
  src="file:///C:/MathJax-master/MathJax-master/MathJax.js?config=TeX-AMS_HTML">
  </script>
  <link rel="stylesheet" href="file:///storage/emulated/0/highlight/styles/pojoaque.css">
  <script type="text/javascript"
  src="file:///storage/emulated/0/highlight/highlight.pack.js">
  </script>
  <link rel="stylesheet" href="file:///C:/highlight/styles/pojoaque.css">
  <script type="text/javascript"
  src="file:///C:/highlight/highlight.pack.js">
  </script>
  <script type="text/javascript">
  document.onkeydown=function(e){if(typeof(disableListenKeyDownEvent)=='undefined'){if(e.keyCode==88||e.keyCode==46){window.open('','_self');window.close()}else if(e.keyCode==8)window.open('index.html','_self')}}
  if(window.location.protocol!="file:"){var d=document,s=d.createElement('script');s.src='/pxp1230.github.io.js';(d.head||d.body).appendChild(s);}else{hljs.initHighlightingOnLoad();}
  </script>
</head>
<body>
<p><a href="http://pan.baidu.com/s/1mhwXdNi">串口监控器.exe</a></p>
<p>首先需要一个客户端就是Arduino的程序<br />
用arduino编译器新建一个程序，直接复制进去就可以了，简单解释一下：setup是启动函数，相当于unity的start函数，而loop函数相当于Update函数，serialEvent是串口事件回调函数。</p>
<pre><code>int ledPin = 9;      // LED connected to digital pin 9
int analogPin = 3;   // potentiometer connected to analog pin 3
int val = 0;         // variable to store the read value
bool readCompleted = false;//指示是否完成读取串口数据
String serialString = &quot;&quot;;//串口数据缓存字符串
unsigned long arduinoTime;

void setup(){
  Serial.begin(9600);
}

void loop()
{
  arduinoTime = micros();//测量时间
  Serial.write((byte*)&amp;arduinoTime,4);//写入时间
  if (readCompleted) {
    Serial.write(61);
    serialString = &quot;&quot;;
    readCompleted = false;
  }
  val = analogRead(analogPin);// read the input pin
  Serial.write(val);
  Serial.write(&#39;;&#39;);//结束标志
}

void serialEvent()//从串口读取字符串
{
  while(Serial.available())
  {
    char inChar = (char)Serial.read();
    if (inChar !=  &#39;;&#39;)//结束标志
    {
      serialString += inChar;
    }
    else
    {
      readCompleted = true;
    }
  }
}</code></pre>
<p>下面是unity的代码：</p>
<pre class="c#"><code>using UnityEngine;
using System.Collections;
using System.IO.Ports;//BuildSetting里API Compatibility Level要修改为.NET2.0，否则无法使用System.IO.Ports;
using UnityEditor;
using System;
using System.Collections.Generic;

public class SerialPortTest : MonoBehaviour
{
    SerialPort port;
    List&lt;int&gt; buffer = new List&lt;int&gt;();
    byte[] arduinoTime = new byte[4];
    uint micros;
    uint deltaMicros;

    void Start()
    {
        string[] names = SerialPort.GetPortNames();
        for (int i = 0; i &lt; names.Length; i++)
        {
            if (names[i].StartsWith(&quot;COM&quot;))
            {
                port = new SerialPort(names[i], 9600);
                port.ReadBufferSize = 1024;//默认值为4096
                port.NewLine = &quot;\r\n&quot;;
                port.ReadTimeout = 1;//Unity在Windows平台下不能通过新线程与串口通信，这样会导致数据丢失，必须在主线程中进行
                //port.DataReceived += PortDataReceived;//Unity不支持DataReceived事件，参考：http://www.cnblogs.com/zhaozhengling/p/3696251.html
                //port.ReceivedBytesThreshold = 1;//理由同上
                break;
            }
        }
        if (port == null)
        {
            Application.Quit();
            EditorApplication.isPlaying = false;
            return;
        }
        else
        {
            port.Open();
        }
    }

    void Update()
    {
        if (buffer.Count &gt; 0)
        {
            int i = 0;
            for (; i &lt; buffer.Count; i++)
            {
                if ((char)buffer[i] == &#39;;&#39;)
                {
                    if (i + 4 &lt; buffer.Count)
                    {
                        arduinoTime[0] = (byte)buffer[i + 1];
                        arduinoTime[1] = (byte)buffer[i + 2];
                        arduinoTime[2] = (byte)buffer[i + 3];
                        arduinoTime[3] = (byte)buffer[i + 4];
                        uint newMicros = BitConverter.ToUInt32(arduinoTime, 0);
                        //UnityEngine.Debug.Log((char)((int)buffer[0]));
                        //UnityEngine.Debug.Log(BitConverter.ToInt16(buffer, 1));
                        //UnityEngine.Debug.Log(BitConverter.ToSingle(buffer, 3));
                        if (micros &lt; newMicros)
                            deltaMicros = newMicros - micros;
                        else
                            deltaMicros = newMicros + uint.MaxValue - micros;
                        micros = newMicros;
                        UnityEngine.Debug.Log(micros / 1000000.0 + &quot;\t&quot; + deltaMicros);
                        i += 4;
                    }
                    else
                    {
                        buffer.RemoveRange(0, i);
                        break;
                    }
                }
            }
        }

        if (port != null &amp;&amp; port.IsOpen)
        {
            if (Input.GetKeyDown(KeyCode.A))
            {
                byte[] bs = new byte[] { 0x61, 0x62, 0x3B };
                port.Write(bs, 0, 3);
            }

            try
            {
                for (int i = 0; i &lt; port.ReadBufferSize; i++)
                {
                    buffer.Add(port.ReadByte());//port.ReadByte()：当串口缓冲区无数据可读时将触发&quot;读取超时&quot;异常
                }
            }
            catch (TimeoutException)
            {
                //UnityEngine.Debug.Log(&quot;读取超时&quot;);
            }
        }
    }
}</code></pre>
</body>
</html>
